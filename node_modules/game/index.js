/* --- Loading factory --- */

var ClientFactory = require("client");
var projectilePool = require("projectile_pool");

/* --- GameServer --- */

function GameServer() {
    this.clients = [];
}

GameServer.prototype.AddClient = function(socket) {
    var client = ClientFactory.CreateClient(socket);
    
    this.clients.push(client);
    
    return client;
};

GameServer.prototype.RemoveClient = function(id) {
    var client = this.clients.find(x => x.id == id);
    
    if (client) {
        this.clients.splice(this.clients.indexOf(client), 1);
    }
};

GameServer.prototype.Broadcast = function (type, data) {
    this.clients.forEach(function (client) {
        client.Send(type, data);
    });
};

GameServer.prototype.GetState = function () {
    var state = [];
    
    this.FillState(state);
    this.ProcessProjectilesCollisions(state);
    this.RemoveProjectiles();
    
    return state;
};

GameServer.prototype.RemoveProjectiles = function() {
   //TODO : Instead of deleting implement using (returning porjectile) object pool
    for (var i = this.clients.length; i--; ) {
        for (var j = this.clients[i].projectiles.length; j--; ) {
            if (this.clients[i].projectiles[j] && this.clients[i].projectiles[j].markedForRemove)
            {
                projectilePool.ReleaseProjectile(this.clients[i].projectiles[j]);
                this.clients[i].projectiles.splice(j, 1);
                j++;
            }
        }
    }//
};

GameServer.prototype.ProcessProjectilesCollisions = function(state) {
    state.forEach(function(self) {
        if (self.type.indexOf("-projectile") > 0)
            return;
        
        var Intersected = state.filter(function (another) {
            if (another.type == self.type)
                return false;
            
            var r1 = 15;
            var r2 = 5;
    
            var dx = self.x - another.x;
            var dy = self.y - another.y;
            dx = dx * dx + dy * dy;
            dy = r1 + r2;
    
            return dx < dy * dy;
        });
    
        for (var index in Intersected) {
            var Entity = Intersected[index];
            
            if (Entity.emitter != self.id)
            {
                Entity.markedForRemove = true;
                self.Damage(Entity.damage);
            }
        }
    });
    
    
};

GameServer.prototype.FillState = function(state) {
    for (var i = this.clients.length; i--; ) {
        state.push(this.clients[i].ship);
        for (var j = this.clients[i].projectiles.length; j--; ) {
            this.clients[i].projectiles[j].CalculateDirections();
            
            state.push(this.clients[i].projectiles[j]);
        }
    }
};

GameServer.prototype.StartMainLoop = function(TargetUpdatesPerSecond, loop) {
    setInterval( loop, 1000 / TargetUpdatesPerSecond);
};

/* --- Exports --- */

module.exports = new GameServer();