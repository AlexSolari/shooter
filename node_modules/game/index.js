/* --- Loading factory --- */

var ClientFactory = require("client");

/* --- GameServer --- */

function GameServer() {
    this.clients = [];
}

GameServer.prototype.AddClient = function(socket) {
    var client = ClientFactory.CreateClient(socket);
    
    this.clients.push(client);
    
    return client;
};

GameServer.prototype.RemoveClient = function(id) {
    var client = this.clients.find(x => x.id == id);
    
    if (client) {
        this.clients.splice(this.clients.indexOf(client), 1);
    }
};

GameServer.prototype.Broadcast = function (type, data) {
    this.clients.forEach(function (client) {
        client.Send(type, data);
    });
};

GameServer.prototype.GetState = function () {
    var state = [];
    
    for (var i = this.clients.length; i--; ) {
        state.push(this.clients[i].ship);
        for (var j = this.clients[i].projectiles.length; j--; ) {
            this.clients[i].projectiles[j].CalculateDirections();
            
            state.push(this.clients[i].projectiles[j]);
        }
    }
    
    //TODO : Instead of deleting implement using (returning porjectile) object pool
    for (var i = this.clients.length; i--; ) {
        for (var j = this.clients[i].projectiles.length; j--; ) {
            if (this.clients[i].projectiles[j] && this.clients[i].projectiles[j].markedForRemove)
            {
                this.clients[i].projectiles.splice(j, 1);
                j++;
            }
        }
    }
    
    return state;
};

GameServer.prototype.StartMainLoop = function(TargetUpdatesPerSecond, loop) {
    setInterval( loop, 1000 / TargetUpdatesPerSecond);
};

/* --- Exports --- */

module.exports = new GameServer();